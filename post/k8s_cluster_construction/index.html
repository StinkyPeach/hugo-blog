<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:site_name" content="Devin Blog">
<meta property="og:type" content="article">
<meta property="og:image" content="https://www.litao.in/img/home-bg.jpg">
<meta property="twitter:image" content="https://www.litao.in/img/home-bg.jpg">
<meta name=title content="K8s Cluster Construction">
<meta property="og:title" content="K8s Cluster Construction">
<meta property="twitter:title" content="K8s Cluster Construction">
<meta name=description content="k8s 集群搭建">
<meta property="og:description" content="k8s 集群搭建">
<meta property="twitter:description" content="k8s 集群搭建">
<meta property="twitter:card" content="summary">
<meta name=keyword content="Devin, Devin Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Kubernetes, 微服务, Microservice">
<link rel="shortcut icon" href=/img/favicon.ico>
<title>K8s Cluster Construction-Devin 博客 | Devin Blog</title>
<link rel=canonical href=/post/k8s_cluster_construction/>
<link rel=stylesheet href=/css/bootstrap.min.css>
<link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css>
<link rel=stylesheet href=/css/zanshang.css>
<link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css rel=stylesheet type=text/css>
<script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
</head>
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
<div class=container-fluid>
<div class="navbar-header page-scroll">
<button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Devin Blog</a>
</div>
<div id=huxblog_navbar>
<div class=navbar-collapse>
<ul class="nav navbar-nav navbar-right">
<li>
<a href=/>Home</a>
</li>
<li><a href=/archive>ARCHIVE</a></li>
<li><a href=/about>ABOUT</a></li>
<li>
<a href=/search><i class="fa fa-search"></i></a>
</li>
</ul>
</div>
</div>
</div>
</nav>
<script>var $body=document.body,$toggle=document.querySelector('.navbar-toggle'),$navbar=document.querySelector('#huxblog_navbar'),$collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic);function handleMagic(a){$navbar.className.indexOf('in')>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf('in')<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script>
<style type=text/css>header.intro-header{background-image:url(/img/home-bg.jpg)}</style>
<header class=intro-header>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<div class=post-heading>
<div class=tags>
<a class=tag href=/tags/k8s title=k8s>
k8s
</a>
</div>
<h1>K8s Cluster Construction</h1>
<h2 class=subheading></h2>
<span class=meta>
Posted by
Devin Blog
on
Monday, August 29, 2022
</span>
</div>
</div>
</div>
</div>
</header>
<article>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container">
<p>本次使用kubeadm 搭建k8s 集群，总共3台服务器（ubuntu20.04)， k8s版本为1.22.2</p>
<h2 id=环境>环境</h2>
<ul>
<li>k8s-master 192.168.30.130</li>
<li>k8s-node1 192.168.30.131</li>
<li>k8s-node2 192.168.30.132</li>
</ul>
<h2 id=关闭防火墙>关闭防火墙</h2>
<p>3台服务器都需要关闭防火墙</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ufw disable
</code></pre></div><h2 id=关闭swap>关闭swap</h2>
<p>3台服务器都需要关闭swap</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 临时关闭swap</span>
swapoff -a 

<span style=color:#75715e># 永久关闭</span>
sed -ri <span style=color:#e6db74>&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab
</code></pre></div><h2 id=修改主机名称>修改主机名称</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 修改192.168.30.130 主机名称为k8s-master</span>
hostnamectl set-hostname k8s-master

<span style=color:#75715e># 修改192.168.30.131 主机名称为k8s-node1</span>
hostnamectl set-hostname k8s-node1

<span style=color:#75715e># 修改192.168.30.130 主机名称为k8s-node2</span>
hostnamectl set-hostname k8s-node2
</code></pre></div><h2 id=添加主机名解析>添加主机名解析</h2>
<p>3台服务器都需要添加</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>vim /etc/hosts
<span style=color:#75715e>## 添加下列文本</span>

<span style=color:#75715e># k8s</span>
192.168.30.130 k8s-master
192.168.30.131 k8s-node1
192.168.30.132 k8s-node2
</code></pre></div><h2 id=安装docker>安装docker</h2>
<p>3台服务器都需要安装</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cd /home
curl -fsSL https://get.docker.com -o get-docker.sh
chmod +x get-docker.sh
<span style=color:#75715e># 使用阿里云的镜像</span>
./get-docker.sh --mirror Aliyun
<span style=color:#75715e># 等待安装成功</span>

<span style=color:#75715e># 修改docker镜像加速和Cgroup Driver</span>
vim /etc/docker/daemon.json
<span style=color:#75715e># 修改为</span>
<span style=color:#f92672>{</span>
	<span style=color:#e6db74>&#34;registry-mirrors&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;https://dhq9bx4f.mirror.aliyuncs.com&#34;</span><span style=color:#f92672>]</span>,
	<span style=color:#e6db74>&#34;exec-opts&#34;</span>: <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;native.cgroupdriver=systemd&#34;</span><span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>

<span style=color:#75715e># 重启docker </span>
systemctl daemon-reload
systemctl restart docker
</code></pre></div><h2 id=安装-kubelet-kubectl-kubeadm>安装 kubelet kubectl kubeadm</h2>
<p>3台服务器都需要安装</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -fsSL https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
<span style=color:#75715e>#新增源</span>
add-apt-repository <span style=color:#e6db74>&#34;deb [arch=amd64] https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&#34;</span>

apt-get update
<span style=color:#75715e># 查看是否存在该版本</span>
apt-cache madison kubelet kubectl kubeadm | grep <span style=color:#e6db74>&#39;1.22.2-00&#39;</span> 
apt-get install -y kubelet<span style=color:#f92672>=</span>1.22.2-00 kubectl<span style=color:#f92672>=</span>1.22.2-00 kubeadm<span style=color:#f92672>=</span>1.22.2-00 

<span style=color:#75715e>## 等待安装成功</span>
kubectl version --client<span style=color:#f92672>=</span>true -o json
<span style=color:#f92672>{</span>
  <span style=color:#e6db74>&#34;clientVersion&#34;</span>: <span style=color:#f92672>{</span>
    <span style=color:#e6db74>&#34;major&#34;</span>: <span style=color:#e6db74>&#34;1&#34;</span>,
    <span style=color:#e6db74>&#34;minor&#34;</span>: <span style=color:#e6db74>&#34;22&#34;</span>,
    <span style=color:#e6db74>&#34;gitVersion&#34;</span>: <span style=color:#e6db74>&#34;v1.22.2&#34;</span>,
    <span style=color:#e6db74>&#34;gitCommit&#34;</span>: <span style=color:#e6db74>&#34;8b5a19147530eaac9476b0ab82980b4088bbc1b2&#34;</span>,
    <span style=color:#e6db74>&#34;gitTreeState&#34;</span>: <span style=color:#e6db74>&#34;clean&#34;</span>,
    <span style=color:#e6db74>&#34;buildDate&#34;</span>: <span style=color:#e6db74>&#34;2021-09-15T21:38:50Z&#34;</span>,
    <span style=color:#e6db74>&#34;goVersion&#34;</span>: <span style=color:#e6db74>&#34;go1.16.8&#34;</span>,
    <span style=color:#e6db74>&#34;compiler&#34;</span>: <span style=color:#e6db74>&#34;gc&#34;</span>,
    <span style=color:#e6db74>&#34;platform&#34;</span>: <span style=color:#e6db74>&#34;linux/amd64&#34;</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

<span style=color:#75715e># 有以上显示 表示安装成功</span>
</code></pre></div><h2 id=初始化k8s-master>初始化k8s-master</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># apiserver-advertise-address 代表你的k8s-master的ip</span>
<span style=color:#75715e># image-repository 使用阿里云的镜像</span>
kubeadm init <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--apiserver-advertise-address<span style=color:#f92672>=</span>192.168.30.130 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--image-repository registry.aliyuncs.com/google_containers <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--kubernetes-version v1.22.2 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--ignore-preflight-errors<span style=color:#f92672>=</span>Swap <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--pod-network-cidr<span style=color:#f92672>=</span>10.244.0.0/16 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>--service-cidr<span style=color:#f92672>=</span>10.1.0.0/16 

<span style=color:#75715e>## 等待安装，成功后执行</span>
<span style=color:#75715e># start using your cluster, you need to run the following as a regular user:</span>
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config

<span style=color:#75715e># Alternatively, if you are the root user, you can run:</span>
export KUBECONFIG<span style=color:#f92672>=</span>/etc/kubernetes/admin.conf
</code></pre></div><pre tabindex=0><code class=language-text/plain data-lang=text/plain># 安装成功后

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.30.130:6443 --token 56bthi.poohqb2p2mavk1am \
        --discovery-token-ca-cert-hash sha256:c964563c7a38a633746225ff6d23f40fde626d7d796b01bffb299a84efbdcf82
</code></pre><h2 id=k8s网络>k8s网络</h2>
<p>You should now deploy a pod network to the cluster.
Run &ldquo;kubectl apply -f [podnetwork].yaml&rdquo; with one of the options listed at: <a href=https://kubernetes.io/docs/concepts/cluster-administration/addons/>https://kubernetes.io/docs/concepts/cluster-administration/addons/</a></p>
<p>使用的<a href=https://github.com/coreos/flannel>flannel</a>的overlay 实现多节点pod通信</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># k8s-master </span>
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

<span style=color:#75715e># 成功后使用kubectl 查看pods</span>
kubectl get pods -A
kube-system   coredns-7f6cbbb7b8-ff64c             1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   coredns-7f6cbbb7b8-txc5w             1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   etcd-k8s-master                      1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   kube-apiserver-k8s-master            1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   kube-controller-manager-k8s-master   1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   kube-flannel-ds-8g5st                1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   kube-flannel-ds-njjgg                1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   kube-flannel-ds-v46xq                1/1     Running   <span style=color:#ae81ff>0</span>          22h
kube-system   kube-proxy-l7rxg                     1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   kube-proxy-pfcbb                     1/1     Running   <span style=color:#ae81ff>0</span>          23h
kube-system   kube-proxy-q289f                     1/1     Running   <span style=color:#ae81ff>0</span>          22h
kube-system   kube-scheduler-k8s-master            1/1     Running   <span style=color:#ae81ff>0</span>          23h
</code></pre></div><h2 id=k8s-node-加入集群>k8s-node 加入集群</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 复制k8s-master的输出信息</span>
kubeadm join 192.168.30.130:6443 --token 56bthi.poohqb2p2mavk1am <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>        --discovery-token-ca-cert-hash sha256:c964563c7a38a633746225ff6d23f40fde626d7d796b01bffb299a84efbdcf82
<span style=color:#75715e># 等待加入成功</span>
kubectl get nodes
k8s-master   Ready    control-plane,master   23h   v1.22.2
k8s-node1    Ready    &lt;none&gt;                 23h   v1.22.2
k8s-node2    Ready    &lt;none&gt;                 23h   v1.22.2
</code></pre></div><h2 id=测试k8s集群>测试k8s集群</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># 创建nginx容器</span>
kubectl create deployment nginx --image<span style=color:#f92672>=</span>nginx
<span style=color:#75715e># 暴露对外端口</span>
kubectl expose deployment nginx --port<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span> --type<span style=color:#f92672>=</span>NodePort
<span style=color:#75715e># 扩容副本</span>
kubectl scale deployment nginx --replicas<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
<span style=color:#75715e># 查看nginx是否运行成功</span>
kubectl get pod,svc
NAME                         READY   STATUS    RESTARTS   AGE
pod/nginx-6799fc88d8-2bps9   1/1     Running   <span style=color:#ae81ff>0</span>          23h
pod/nginx-6799fc88d8-9psfx   1/1     Running   <span style=color:#ae81ff>0</span>          22h
pod/nginx-6799fc88d8-tnfrk   1/1     Running   <span style=color:#ae81ff>0</span>          22h

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>        AGE
service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        23h
service/nginx        NodePort    10.102.105.92   &lt;none&gt;        80:31150/TCP   23h
root@k8s-master:~#
<span style=color:#75715e># 浏览器访问 http://192.168.30.130:31150 http://192.168.30.131:31150  http://192.168.30.132:31150  均可以成功访问</span>
</code></pre></div>
<div class="entry-shang text-center">
<p> 「如果这篇文章对你有用,请随意打赏」</p>
<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class=zs-modal-bg></div>
<div class=zs-modal-box>
<div class=zs-modal-head>
<button type=button class=close>×</button>
<p class=tip><span>如果这篇文章对你有用,请随意打赏</span></p>
</div>
<div class=zs-modal-body>
<div class=zs-modal-btns>
<button class="btn btn-blink" data-num=1>1元</button>
<button class="btn btn-blink" data-num=5>5元</button>
<button class="btn btn-blink" data-num=10>10元</button>
<button class="btn btn-blink" data-num=20>20元</button>
<button class="btn btn-blink" data-num=50>50元</button>
<button class="btn btn-blink" data-num=0>老板随意</button>
</div>
<div class=zs-modal-pay>
<button class="btn btn-bred" id=pay-text>2元</button>
<p>使用<span id=pay-type>微信</span>扫描二维码完成支付</p>
<img src=/img/reward/wechat-1.png id=pay-image>
</div>
</div>
<div class=zs-modal-footer>
<label><input type=radio name=zs-type value=wechat class=zs-type checked><span><span class=zs-wechat><img src=/img/reward/wechat-btn.png></span></label>
<label><input type=radio name=zs-type value=alipay class=zs-type class=zs-alipay><img src=/img/reward/alipay-btn.png></span></label>
</div>
</div>
<script type=text/javascript src=/js/reward.js></script>
<hr>
<ul class=pager>
<li class=previous>
<a href=/post/welcome_to_my_blog/ data-toggle=tooltip data-placement=top title="Welcome To My Blog">&larr;
Previous Post</a>
</li>
</ul>
</div>
<div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container">
<div class=side-catalog>
<hr class="hidden-sm hidden-xs">
<h5>
<a class=catalog-toggle href=#>CATALOG</a>
</h5>
<ul class=catalog-body></ul>
</div>
</div>
<div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container">
<section>
<hr class="hidden-sm hidden-xs">
<h5><a href=/tags/>FEATURED TAGS</a></h5>
<div class=tags>
</div>
</section>
<section>
<hr>
<h5>FRIENDS</h5>
<ul class=list-inline>
<li><a target=_blank href=https://www.google.com>友情招商</a></li>
</ul>
</section>
</div>
</div>
</div>
</article>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center">
<li>
<a href=mailto:mrslitao@163.com>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
<li>
<a target=_blank href=https://github.com/StinkyPeach>
<span class="fa-stack fa-lg">
<i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i>
</span>
</a>
</li>
</ul>
<p class="copyright text-muted">
Copyright &copy; Devin Blog 2023
<br>
Hugo Theme by <a href>Devin</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=stinkypeach&repo=hugo-simple-theme&type=star&count=true"></iframe>
</p>
</div>
</div>
</div>
</footer>
<script>function loadAsync(f,b){var c=document,d='script',a=c.createElement(d),e=c.getElementsByTagName(d)[0];a.src=f,b&&a.addEventListener('load',function(a){b(null,a)},!1),e.parentNode.insertBefore(a,e)}</script>
<script>$('#tag_cloud').length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'}},$('#tag_cloud a').tagcloud()})</script>
<script>loadAsync("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js",function(){var a=document.querySelector("nav");a&&FastClick.attach(a)})</script>
<script type=text/javascript>function generateCatalog(a){_containerSelector='div.post-container';var h=$(_containerSelector),c,d,e,f,g,b;return c=h.find('h1,h2,h3,h4,h5,h6'),$(a).html(''),c.each(function(){d=$(this).prop('tagName').toLowerCase(),g="#"+$(this).prop('id'),e=$(this).text(),b=$('<a href="'+g+'" rel="nofollow">'+e+'</a>'),f=$('<li class="'+d+'_nav"></li>').append(b),$(a).append(f)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(a){a.preventDefault(),$('.side-catalog').toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$('.catalog-body').onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script>
</body>
</html>